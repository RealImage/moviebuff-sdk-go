name: Build

on: push

jobs:
    build:
        name: Build
        runs-on: ubuntu-latest
        strategy:
            matrix:
                package: [".", "v2"]
        defaults:
            run:
              working-directory: ${{ matrix.package }}
        steps:
            -   name: Set up Go 1.15
                uses: actions/setup-go@v2
                with:
                    go-version: ^1.15

            -   name: Check out
                uses: actions/checkout@v2

            -   name: Get dependencies
                run: go get -v ./...

            -   name: Enforce Go Formatted Code
                run: "! go fmt ./... 2>&1 | read"

            -   name: Identify Vet Errors
                run: go vet ./...

            -   name: Build
                run: go build ./...

            -   name: Test
                run: go test -race -v ./...

            -   name: CI fail
                uses: 8398a7/action-slack@v3
                with:
                    status: ${{ job.status }}
                    fields: repo, message, commit, author, ref
                env:
                    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
                if: ${{ failure() }}